<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=0.5,minimum-scale=0.6,maximum-scale=0.5,user-scalable=no" />
		<meta name="misapplication-tap-highlight" content="no" />
		<meta name="HandheldFriendly" content="true" />
		<title></title>
		<script src="resource/dev/libs/jquery-3.2.1.js"></script>
		<script src="resource/dev/libs/mui.min.js"></script>
		<script src="resource/dev/libs/enterfocus.js"></script>
		<script src="resource/dev/libs/app.js"></script>

		<link rel="stylesheet" href="resource/dev/css/pages/login/login.css" />
		<link rel="stylesheet" href="resource/dev/css/pages/login/layer.css" />
		<script type="text/javascript" charset="utf-8">
			(function(mui, doc) {
				if(mui.os.ios) {
					plus.navigator.setFullscreen(true);
				}
				plus.navigator.closeSplashscreen();

				var as = 'pop-in'; // 默认窗口动画

				mui.init();
				mui.plusReady(function() {
					plus.screen.lockOrientation("portrait-primary");
					var settings = app.getSettings();
					var state = app.getState();
					var mainPage = mui.preload({
						"id": 'main',
						"url": 'main.html'
					});
					var main_loaded_flag = false;
					mainPage.addEventListener("loaded", function() {
						main_loaded_flag = true;
					});
					var toMain = function() {
						//使用定时器的原因：
						//可能执行太快，main页面loaded事件尚未触发就执行自定义事件，此时必然会失败
						var id = setInterval(function() {
							if(main_loaded_flag) {
								clearInterval(id);
								mui.fire(mainPage, 'show', null);
								mainPage.show("pop-in");
							}
						}, 20);
					};
					//第三方登录
					var authBtns = ['qihoo', 'weixin', 'sinaweibo', 'qq']; //配置业务支持的第三方登录
					var auths = {};
					console.info($('#oauth-area')[0])
					var oauthArea = doc.querySelector('.oauth-area');
					function auth() {
						app.setState(null);
						plus.oauth.getServices(function(services) {
							for(var i in services) {
								var service = services[i];
								auths[service.id] = service;
								if(~authBtns.indexOf(service.id)) {
									var isInstalled = app.isInstalled(service.id);
									var btn = document.createElement('div');
									//如果微信未安装，则为不启用状态
									btn.setAttribute('class', 'oauth-btn' + (!isInstalled && service.id === 'weixin' ? (' disabled') : ''));
									btn.authId = service.id;
									//console.log(btn.authId);
									btn.style.backgroundImage = 'url("resource/dev/images/common/' + service.id + '.png")';
									console.log(btn);
									//oauthArea.appendChild(btn);
								}
							}
							mui(oauthArea).on('tap', '.oauth-btn', function() {
								if(this.classList.contains('disabled')) {
									plus.nativeUI.toast('您尚未安装微信客户端');
									return;
								}
								var auth = auths[this.authId];
								var waiting = plus.nativeUI.showWaiting();
								auth.login(function() {
									waiting.close();
									plus.nativeUI.toast("登录认证成功");
									auth.getUserInfo(function() {
										plus.nativeUI.toast("获取用户信息成功");
										var name = auth.userInfo.nickname || auth.userInfo.name;
										console.log(JSON.stringify(auth));
										app.createState(name, function() {
											//toMain();
										});
									}, function(e) {
										plus.nativeUI.toast("获取用户信息失败：" + e.message);
									});
								}, function(e) {
									waiting.close();
									plus.nativeUI.toast("登录认证失败：" + e.message);
								});
							});
						}, function(e) {
							//oauthArea.style.display = 'none';
							plus.nativeUI.toast("获取登录认证失败：" + e.message);
						});
					}
					
					auth();
					//检查 "登录状态/锁屏状态" 开始
//					if(settings.autoLogin && state.token && settings.gestures) {
//						mui.openWindow({
//							url: 'unlock.html',
//							id: 'unlock',
//							show: {
//								aniShow: 'pop-in'
//							},
//							waiting: {
//								autoShow: false
//							}
//						});
//					} else if(settings.autoLogin && state.token) {
//						//toMain();
//					} else {
//
//					}
					// close splash

					window.addEventListener('resize', function() {
						oauthArea.style.display = document.body.clientHeight > 400 ? 'block' : 'none';
					}, false);
				});
			}(mui, document));
		</script>
	</head>
	<style>
		.body-bg {
			background: url("resource/dev/images/common/bg.jpg");
			background-size: 100% 100%;
			background-position: 0px 0px;
		}
	</style>

	<body class="body-bg">
		<div class="whole">
			<div class="title"></div>
			<div class="coordinates-icon">
				<div class="coordinates topAct">
					<img src="resource/dev/images/login/coordinates.png" />
				</div>
				<div class="circle-1-1 circle-show-2"></div>
				<div class="circle-2-2 circle-show-1"></div>
				<div class="circle-3-3 circle-show"></div>
			</div>
			<div class="login-form">
				<form action="#">
					<div class="user-name common-div">
						<span class="eamil-icon common-icon">
	                	<img src="resource/dev/images/login/eamil.png" />
	                </span>
						<input type="email" name="username" value="" placeholder="帐号" />
					</div>
					<div class="user-pasw common-div">
						<span class="pasw-icon common-icon">
	                	<img src="resource/dev/images/login/password.png" />
	                </span>
						<input type="password" name="password" value="" placeholder="密码" />
					</div>
					<div class="login-btn common-div">登入</div>
				</form>
			</div>
			<div class="forgets">
				<a href="#" style="color: #000;">忘记密码</a>
				<a href="#" style="color: #000;">注册用户</a>
			</div>
			<div class="mui-content-padded oauth-area" id="oauth-area">

			</div>
		</div>
	</body>

</html>